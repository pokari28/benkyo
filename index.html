<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á§æ‰ºöÁßë ‰∏ÄÂïè‰∏ÄÁ≠î„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f8ff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .game-container {
            background-color: white;
            width: 480px; 
            height: 600px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 4px solid #ff99cc;
            display: flex;
            flex-direction: row;
            position: relative;
        }

        #mute-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            border: 2px solid #ff99cc;
            font-size: 20px;
            cursor: pointer;
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #title-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .title-text {
            font-size: 28px;
            font-weight: bold;
            color: #ff6699;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #fff;
        }
        .title-img {
            width: 200px;
            height: 200px;
            object-fit: contain;
            margin-bottom: 20px;
        }
        
        .btn-area {
            display: flex;
            flex-direction: column;
            gap: 15px; 
            width: 80%;
        }
        .start-btn {
            color: white;
            border: none;
            padding: 15px 0;
            border-radius: 30px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            width: 100%;
        }
        .start-btn:active { transform: scale(0.95); }
        
        .beginner-mode {
            background-color: #43e97b; 
            border: 2px solid #38f9d7;
        }
        .normal-mode {
            background-color: #ff6699;
            border: 2px solid #ff99cc;
        }

        .highscore-text {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .side-panel {
            width: 60px;
            background-color: #fff0f5;
            border-left: 2px solid #ff99cc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 0;
            z-index: 20;
        }

        .point-label {
            font-size: 12px;
            font-weight: bold;
            color: #ff6699;
            writing-mode: vertical-rl;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }

        .gauge-container {
            width: 20px;
            height: 100%;
            background-color: #fff;
            border: 2px solid #ff99cc;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse;
        }
        .gauge-fill {
            width: 100%;
            height: 0%;
            background: linear-gradient(0deg, #4facfe 0%, #00f2fe 100%);
            transition: height 0.5s ease-out, background 0.5s;
        }
        .score-num {
            margin-top: 10px;
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .character-area {
            background-color: #ffebf5;
            height: 320px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            position: relative;
            overflow: hidden;
        }
        .character-img {
            width: 360px;
            height: 360px;
            object-fit: contain;
            transition: transform 0.2s;
            margin-bottom: -40px; 
            z-index: 1;
        }
        
        .speech-bubble {
            position: absolute;
            bottom: 10px; 
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            padding: 12px 16px;
            width: 90%;
            min-height: 50px;
            border: 2px solid #333;
            font-weight: 900;
            color: #000; 
            text-shadow: 2px 2px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff;
            z-index: 10;
            font-size: 18px;
            line-height: 1.5;
            text-align: left;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .quiz-area { 
            flex: 1;
            padding: 20px; 
            background-color: white;
            z-index: 5;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .question-text {
            font-size: 18px; 
            margin-bottom: 20px;
            font-weight: bold;
            min-height: 60px;
        }

        .options-grid { display: grid; gap: 8px; }
        button {
            background-color: #4da6ff;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover { background-color: #3385cc; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .correct-anim { animation: jump 0.5s; }
        .wrong-anim { animation: shake 0.5s; }

        @keyframes jump { 0% { transform: translateY(0); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0); } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>

<div class="game-container">
    <div id="mute-btn" onclick="toggleMute()">üîä</div>

    <div id="title-screen">
        <h1 class="title-text">Á§æ‰ºöÁßë<br>‰∏ÄÂïè‰∏ÄÁ≠î„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ</h1>
        <img src="normal.png" alt="„Çø„Ç§„Éà„É´ÁîªÂÉè" class="title-img">
        
        <div class="btn-area">
            <button class="start-btn beginner-mode" onclick="startGame('beginner')">üî∞ ÂàùÂøÉËÄÖ„É¢„Éº„Éâ (10Âïè)</button>
            <button class="start-btn normal-mode" onclick="startGame('normal')">üî• ÈÄöÂ∏∏„É¢„Éº„Éâ (30Âïè)</button>
        </div>

        <div class="highscore-text">ÊúÄÈ´ò„Éù„Ç§„É≥„Éà: <span id="highscore-num">0</span>%</div>
    </div>

    <div class="main-content">
        <div class="character-area">
            <img id="char-img" src="normal.png" alt="„Ç≠„É£„É©„ÇØ„Çø„ÉºÁîªÂÉè" class="character-img">
            <div id="char-voice" class="speech-bubble"></div>
        </div>
        <div class="quiz-area">
            <div id="question-text" class="question-text">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            <div id="options" class="options-grid"></div>
        </div>
    </div>

    <div class="side-panel">
        <span class="point-label">„Éù„Ç§„É≥„Éà</span>
        <div class="gauge-container">
            <div id="gauge-fill" class="gauge-fill"></div>
        </div>
        <span id="score-text" class="score-num">0%</span>
    </div>
</div>

<script src="questions.js"></script>

<script>
    const images = {
        normal: "normal.png",
        normal10: "normal10.png",
        normal20: "normal20.png",
        normal30: "normal30.png",
        good: "good.png",
        bad: "bad.png",
        special: "special.png",
        special20: "special20.png",
        special30: "special30.png",
        special_max: "special_max.png"
    };

    // --- Audio Settings ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    let isMuted = false;
    let bgmOsc = null;
    let bgmGain = null;
    let bgmInterval = null;
    let bgmNoteIndex = 0;

    const NOTES = {
        'C3': 130.81, 'D3': 146.83, 'E3': 164.81, 'F3': 174.61, 'G3': 196.00, 'A3': 220.00, 'B3': 246.94,
        'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00, 'B4': 493.88,
        'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99, 'A5': 880.00, 'B5': 987.77,
        'R': 0 
    };

    const bgmScores = {
        // ‚òÖÂàùÂøÉËÄÖ„É¢„Éº„ÉâÁî®BGMÔºà„ÇÜ„Å£„Åü„Çä„É°„Éå„Ç®„ÉÉ„ÉàÈ¢®Ôºâ
        beginner: [
            {n:'G4',l:2}, {n:'E4',l:1}, {n:'C4',l:1}, {n:'G4',l:2}, {n:'E4',l:2}, 
            {n:'A4',l:2}, {n:'F4',l:1}, {n:'D4',l:1}, {n:'A4',l:2}, {n:'F4',l:2},
            {n:'E4',l:2}, {n:'D4',l:2}, {n:'C4',l:2}, {n:'B3',l:2}, 
            {n:'C4',l:4}, {n:'R',l:2}
        ],
        // ÈÄöÂ∏∏„É¢„Éº„ÉâÔºàLv0Ôºâ
        level0: [
            {n:'C4',l:2}, {n:'E4',l:2}, {n:'G4',l:2}, {n:'E4',l:2}, 
            {n:'C4',l:2}, {n:'G4',l:2}, {n:'C5',l:4},
            {n:'A4',l:2}, {n:'F4',l:2}, {n:'D4',l:2}, {n:'F4',l:2},
            {n:'E4',l:2}, {n:'D4',l:2}, {n:'C4',l:4}
        ],
        level10: [
            {n:'G4',l:1}, {n:'A4',l:1}, {n:'B4',l:1}, {n:'C5',l:1}, {n:'D5',l:2}, {n:'C5',l:2},
            {n:'B4',l:1}, {n:'A4',l:1}, {n:'G4',l:1}, {n:'F4',l:1}, {n:'E4',l:2}, {n:'G4',l:2},
            {n:'F4',l:1}, {n:'F4',l:1}, {n:'E4',l:1}, {n:'E4',l:1}, {n:'D4',l:1}, {n:'D4',l:1}, {n:'G4',l:2}
        ],
        level20: [
            {n:'A3',l:1}, {n:'A3',l:1}, {n:'C4',l:1}, {n:'E4',l:1}, {n:'A4',l:2}, {n:'R',l:1}, {n:'G4',l:1},
            {n:'F4',l:2}, {n:'E4',l:2}, {n:'D4',l:2}, {n:'E4',l:2},
            {n:'A3',l:1}, {n:'B3',l:1}, {n:'C4',l:1}, {n:'D4',l:1}, {n:'E4',l:4}
        ],
        level30: [
            {n:'C5',l:1}, {n:'G4',l:1}, {n:'E4',l:1}, {n:'C4',l:1}, {n:'G4',l:1}, {n:'C5',l:1}, {n:'E5',l:2},
            {n:'F5',l:1}, {n:'C5',l:1}, {n:'A4',l:1}, {n:'F4',l:1}, {n:'A4',l:1}, {n:'C5',l:1}, {n:'F5',l:2},
            {n:'G5',l:1}, {n:'F5',l:1}, {n:'E5',l:1}, {n:'D5',l:1}, {n:'C5',l:1}, {n:'B4',l:1}, {n:'C5',l:2}
        ]
    };

    let bgmTimer = null;
    let currentScoreData = [];
    let noteIndex = 0;
    let baseTempo = 150; 

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioContext();
    }

    function startGeneratedBGM(mode, level) {
        if (isMuted) return;
        if (bgmTimer) clearTimeout(bgmTimer); 

        initAudio();
        
        // ‚òÖÂàùÂøÉËÄÖ„É¢„Éº„Éâ„ÅØÂ∞ÇÁî®BGM
        if (mode === 'beginner') {
            currentScoreData = bgmScores.beginner;
            baseTempo = 200; // „ÇÜ„Å£„Åè„Çä
        } else {
            // ÈÄöÂ∏∏„É¢„Éº„Éâ„ÅØ„É¨„Éô„É´„ÅßÂ§âÂåñ
            if (level >= 30) { currentScoreData = bgmScores.level30; baseTempo = 100; } 
            else if (level >= 20) { currentScoreData = bgmScores.level20; baseTempo = 120; } 
            else if (level >= 10) { currentScoreData = bgmScores.level10; baseTempo = 130; } 
            else { currentScoreData = bgmScores.level0; baseTempo = 180; }
        }
        
        noteIndex = 0;
        playNextNote();
    }

    function playNextNote() {
        if (isMuted) return;
        if (!currentScoreData || currentScoreData.length === 0) return;

        const noteData = currentScoreData[noteIndex];
        const freq = NOTES[noteData.n];
        const duration = noteData.l * baseTempo; 

        if (freq > 0) {
            playOscillator(freq, duration * 0.001 * 0.8, 'square', 0.03); 
        }

        noteIndex = (noteIndex + 1) % currentScoreData.length;
        bgmTimer = setTimeout(playNextNote, duration);
    }

    function playOscillator(freq, duration, type, volume) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        osc.start(now);
        osc.stop(now + duration);
        gain.gain.setValueAtTime(volume, now);
        gain.gain.linearRampToValueAtTime(0, now + duration);
    }

    function stopBGM() {
        if (bgmTimer) {
            clearTimeout(bgmTimer);
            bgmTimer = null;
        }
    }

    function toggleMute() {
        isMuted = !isMuted;
        const btn = document.getElementById("mute-btn");
        if (isMuted) {
            btn.innerText = "üîá";
            stopBGM();
        } else {
            btn.innerText = "üîä";
            if (document.getElementById("title-screen").style.display === "none") {
                startGeneratedBGM(currentMode, score);
            }
        }
    }

    function playTypeSound() {
        if (isMuted) return;
        initAudio();
        playOscillator(800 + Math.random() * 200, 0.05, 'square', 0.02);
    }

    function playGoodSound() {
        if (isMuted) return;
        initAudio();
        const now = audioCtx.currentTime;
        playOscillator(660, 0.1, 'sine', 0.1);
        setTimeout(() => playOscillator(880, 0.3, 'sine', 0.1), 100);
    }

    function playBadSound() {
        if (isMuted) return;
        initAudio();
        playOscillator(150, 0.2, 'sawtooth', 0.1);
        setTimeout(() => playOscillator(100, 0.3, 'sawtooth', 0.1), 200);
    }

    function playFanfare() {
        if (isMuted) return;
        stopBGM(); 
        initAudio();
        setTimeout(() => playOscillator(523.25, 0.15, 'square', 0.1), 0);
        setTimeout(() => playOscillator(659.25, 0.15, 'square', 0.1), 150);
        setTimeout(() => playOscillator(783.99, 0.15, 'square', 0.1), 300);
        setTimeout(() => playOscillator(1046.50, 0.6, 'square', 0.1), 450);
        setTimeout(() => {
            if (!isMuted && document.getElementById("title-screen").style.display === "none") {
                startGeneratedBGM(currentMode, score);
            }
        }, 1500);
    }
    
    function playStartSound() {
        if (isMuted) return;
        initAudio();
        setTimeout(() => playOscillator(1046.50, 0.1, 'square', 0.1), 0);
        setTimeout(() => playOscillator(1318.51, 0.4, 'square', 0.1), 100);
    }

    // --- Game Logic ---

    let typeWriterTimer;
    function showDialogue(text) {
        const bubble = document.getElementById("char-voice");
        bubble.innerHTML = "";
        if (typeWriterTimer) clearTimeout(typeWriterTimer);
        let i = 0;
        function typeChar() {
            if (i < text.length) {
                bubble.textContent += text.charAt(i);
                playTypeSound();
                i++;
                typeWriterTimer = setTimeout(typeChar, 60);
            }
        }
        typeChar();
    }

    let questionTypeTimer;
    function showQuestionText(text) {
        const qBox = document.getElementById("question-text");
        qBox.innerHTML = "";
        if (questionTypeTimer) clearTimeout(questionTypeTimer);
        let i = 0;
        function typeQ() {
            if (i < text.length) {
                qBox.textContent += text.charAt(i);
                playTypeSound(); 
                i++;
                questionTypeTimer = setTimeout(typeQ, 40);
            }
        }
        typeQ();
    }

    const preQuestions = [
        "Ë°å„Åè„ÇàÔºÅ", "Ê¨°Ë®Ä„ÅÜ„ÇàÔºÅ", "„Åò„ÇÉ„ÅÇÊ¨°„ÅØ„Åì„ÇåÔºÅ", "Ê∫ñÂÇô„ÅØ„ÅÑ„ÅÑÔºü", "Ê¨°„ÅÆÂïèÈ°åÔºÅ",
        "„Åï„ÅÇ„ÄÅÊ¨°ÔºÅ", "„Åì„Çå„ÅØ„Å©„ÅÜ„Åã„Å™Ôºü", "ÈõÜ‰∏≠„Åó„Å¶„Å≠ÔºÅ", "„Çà„ÅèËÅû„ÅÑ„Å¶ÔºÅ", "Ê¨°„ÅØ„Åì„Çå„Å†ÔºÅ",
        "„Å©„Çì„Å©„ÇìË°å„Åè„ÇàÔºÅ", "„Åæ„Å†„Åæ„Å†Ë°å„Åè„ÇàÔºÅ", "„Å§„ÅÑ„Å¶„Åì„Çå„ÇãÔºü", "Ê¨°„ÅØÈõ£„Åó„ÅÑ„Åã„ÇÇÔºü", "„Åï„ÅÇ„ÄÅÈ†ëÂºµ„Å£„Å¶ÔºÅ",
        "Ê¨°„ÅÆÂãùË≤†ÔºÅ", "Ê∞óÂêàÂÖ•„Çå„Å¶ÔºÅ", "Ê∑±ÂëºÂê∏„Åó„Å¶‚Ä¶„ÅØ„ÅÑÔºÅ", "Ê∫ñÂÇô‰∏áÁ´ØÔºü", "„Åï„ÅÇ„ÄÅÁ≠î„Åà„Å¶ÔºÅ",
        "Ê¨°„ÅØ„Å©„ÅÆÂàÜÈáé„Åã„Å™Ôºü", "„Çà„Éº„Åó„ÄÅÊ¨°„ÅØ‚Ä¶", "Âºµ„ÇäÂàá„Å£„Å¶Ë°å„Åì„ÅÜÔºÅ", "Ê¨°„ÇÇÊ≠£Ëß£„Åó„Å°„ÇÉ„Åä„ÅÜÔºÅ", "Ê≤πÊñ≠„Åó„Å™„ÅÑ„ÅßÔºÅ",
        "Ê¨°„ÅÆÂïèÈ°åË°å„Åè„Å≠ÔºÅ", "„Åï„ÅÇ„ÄÅÊ¨°„Å†ÔºÅ", "Ê∫ñÂÇôOKÔºü", "„É¨„ÉÉ„ÉÑ„Ç¥„ÉºÔºÅ", "Ê¨°„ÅØ„Åì„ÇåÔºÅ„Çè„Åã„ÇãÔºü",
        "„Åæ„Å†„Åæ„Å†Á∂ö„Åè„ÇàÔºÅ", "ÂÖ®ÂïèÊ≠£Ëß£ÁõÆÊåá„Åó„Å¶ÔºÅ"
    ];

    const reactions = {
        correct: ["„Åù„ÅÆË™øÂ≠êÔºÅ", "Ê≠£Ëß£ÔºÅ„ÅÑ„ÅÑ„ÅûÔºÅ", "„Éù„Ç§„É≥„Éà‰∏äÊòá‰∏≠ÔºÅ", "„ÇÑ„Çã„Å≠ÔºÅ", "Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ", "Âêõ„ÅØÂ§©Êâç„Åã„ÇÇÔºÅÔºü", "ÂÜ¥„Åà„Å¶„Çã„Å≠ÔºÅ", "ÂÆåÁíß„Å™Á≠î„ÅàÔºÅ", "„Éñ„É©„Éú„ÉºÔºÅ", "Ê≠¥Âè≤ÂçöÂ£´„Å†„Å≠ÔºÅ", "„Åô„Åî„Éº„ÅÑÔºÅ", "Ë¶ã‰∫ã„Å™Ê≠£Ëß£ÔºÅ", "ÂãâÂº∑„ÅÆÊàêÊûúÔºÅ"],
        wrong: ["„Éâ„É≥„Éû„Ç§ÔºÅ", "Ê¨°„ÅØÂΩì„Å¶„Çà„ÅÜÔºÅ", "Âæ©Áøí„ÅåÂ§ß‰∫ãÔºÅ", "„ÅÇ„Å°„ÇÉ„Éº‚Ä¶", "ÊÉú„Åó„Åã„Å£„Åü„Åã„ÇÇÔºü", "„ÇÇ„ÅÜ‰∏ÄÂõûÁ¢∫Ë™çÔºÅ"],
        special10: "10ÂïèÊ≠£Ëß£ÔºÅ„ÅÑ„ÅÑ„Éö„Éº„Çπ„Å†„ÇàÔºÅ",
        special20: "20ÂïèÊ≠£Ëß£ÔºÅ„Ç®„É©„Ç§„Ç®„É©„Ç§ÔºÅ",
        special30: "30ÂïèÊ≠£Ëß£ÔºÅÂÖàÁîü„ÇÇÂ¨â„Åó„ÅÑ„ÇàÔºÅ"
    };

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- State Variables ---
    let currentQIndex = 0;
    let score = 0;
    let quizData = [];
    let highScore = localStorage.getItem('socialQuizHighScore') || 0;
    let isQuestionFailed = false;
    let currentMode = 'normal'; 

    const titleScreen = document.getElementById("title-screen");
    const highscoreNum = document.getElementById("highscore-num");
    const charImg = document.getElementById("char-img");
    const questionText = document.getElementById("question-text");
    const optionsDiv = document.getElementById("options");
    const gaugeFill = document.getElementById("gauge-fill");
    const scoreText = document.getElementById("score-text");

    highscoreNum.innerText = highScore;

    // --- Start Game (Mode Selection) ---
    function startGame(mode) {
        initAudio(); // Èü≥Â£∞„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅÆÂàùÊúüÂåñ„ÇíÁ¢∫ÂÆü„Å´Ë°å„ÅÜ
        playStartSound();
        titleScreen.style.display = 'none'; 
        
        currentMode = mode;
        // „É¢„Éº„Éâ„Å´Âêà„Çè„Åõ„Å¶BGMÂÜçÁîü
        startGeneratedBGM(currentMode, 0);
        
        initGame();
    }

    function initGame() {
        if (typeof questions === 'undefined') {
            questionText.innerText = "„Ç®„É©„ÉºÔºöquestions.js„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì";
            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éá„Éº„Çø„Åå„Å™„Åè„Å¶„ÇÇÁ©∫ÈÖçÂàó„ÅßÈÄ≤„ÇÅ„ÇãÔºà„Ç®„É©„ÉºÂÅúÊ≠¢Èò≤Ê≠¢Ôºâ
            questions = [];
        }
        
        if (currentMode === 'beginner') {
            // ‚òÖÂàùÂøÉËÄÖ„É¢„Éº„ÉâÔºöÊúÄÂàù„ÅÆ10Âïè„ÇíÂõ∫ÂÆö„Åß‰Ωø„ÅÜÔºà„Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢„ÅØÂâäÈô§„Åó„ÄÅÂÆâÂÖ®„Å´Ôºâ
            quizData = questions.slice(0, 10);
            // „ÇÇ„Åó„Éá„Éº„Çø„ÅåË∂≥„Çä„Å™„ÅÑÂ†¥Âêà„ÅØ„ÅÇ„Çã„Å†„Åë‰Ωø„ÅÜ
            if (quizData.length === 0) {
                questionText.innerText = "ÂïèÈ°å„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºÅ";
                return;
            }
        } else {
            // ‚òÖÈÄöÂ∏∏„É¢„Éº„ÉâÔºöÂÖ®Âïè„Åã„Çâ„É©„É≥„ÉÄ„É†30Âïè
            let shuffled = shuffle([...questions]);
            quizData = shuffled.slice(0, 30);
        }
        
        currentQIndex = 0;
        score = 0;
        isQuestionFailed = false;
        
        charImg.src = getCurrentNormalImage();
        updateGauge();
        showQuestion();
    }
    
    function getCurrentNormalImage() {
        if (score >= 30) return images.normal30 || images.normal20;
        if (score >= 20) return images.normal20;
        if (score >= 10) return images.normal10;
        return images.normal;
    }
    
    function updateGauge() {
        let percentage = Math.round((score / quizData.length) * 100);
        gaugeFill.style.height = percentage + "%";
        scoreText.innerText = percentage + "%";
        if (percentage < 30) { gaugeFill.style.background = "linear-gradient(0deg, #4facfe 0%, #00f2fe 100%)"; }
        else if (percentage < 70) { gaugeFill.style.background = "linear-gradient(0deg, #43e97b 0%, #38f9d7 100%)"; }
        else { gaugeFill.style.background = "linear-gradient(0deg, #fa709a 0%, #fee140 100%)"; }
    }

    function showQuestion() {
        if (currentQIndex >= quizData.length) {
            finishGame();
            return;
        }

        const q = quizData[currentQIndex];
        isQuestionFailed = false;

        const displayQuestionContent = () => {
             showQuestionText(`Q${currentQIndex + 1}. ${q.q}`);
             
             optionsDiv.innerHTML = "";
             q.options.forEach((opt, index) => {
                 const btn = document.createElement("button");
                 btn.innerText = opt;
                 btn.onclick = (e) => checkAnswer(index, q.ans, e.target);
                 optionsDiv.appendChild(btn);
             });
             
             charImg.src = getCurrentNormalImage();
             charImg.classList.remove("correct-anim", "wrong-anim");
             showDialogue(""); 
        };

        let prePhrase = "";
        if (currentQIndex === 0) {
            prePhrase = "ÂÖàÁîü„Å®‰∏ÄÁ∑í„Å´È†ëÂºµ„ÇçÔºÅ";
        } else {
            prePhrase = preQuestions[Math.floor(Math.random() * preQuestions.length)];
        }

        showDialogue(prePhrase);
        questionText.innerHTML = "";
        optionsDiv.innerHTML = "";
        charImg.src = getCurrentNormalImage();

        setTimeout(() => {
            displayQuestionContent();
        }, 1000);
    }

    function checkAnswer(selectedIndex, correctIndex, clickedBtn) {
        if (selectedIndex === correctIndex) {
            // Correct
            const buttons = optionsDiv.querySelectorAll("button");
            buttons.forEach(btn => btn.disabled = true);
            clickedBtn.style.backgroundColor = "#ff99cc"; 

            if (!isQuestionFailed) {
                score++;
                updateGauge();
                // „Çπ„Ç≥„Ç¢Â§âÂåñ„Å´Âøú„Åò„Å¶BGMÊõ¥Êñ∞
                startGeneratedBGM(currentMode, score);
            }

            let specialReaction = null;
            let specialImage = null;
            if (!isQuestionFailed) {
                if (score === 20) {
                    specialReaction = reactions.special20;
                    specialImage = images.special20;
                } else if (score === 30) {
                    specialReaction = reactions.special30;
                    specialImage = images.special30;
                } else if (score === 10) { 
                     specialReaction = reactions.special10;
                     specialImage = images.special;
                }
            }

            if (specialImage) {
                playFanfare();
                showDialogue(specialReaction);
                charImg.src = specialImage;
                currentQIndex++;
                setTimeout(showQuestion, 4000); 
                return;
            }

            playGoodSound();
            const randomPraise = reactions.correct[Math.floor(Math.random() * reactions.correct.length)];
            showDialogue(randomPraise);
            charImg.src = images.good; 
            charImg.classList.add("correct-anim");
            
            currentQIndex++;
            setTimeout(showQuestion, 2000);

        } else {
            // Wrong
            isQuestionFailed = true;
            playBadSound();
            const randomEncourage = reactions.wrong[Math.floor(Math.random() * reactions.wrong.length)];
            showDialogue(randomEncourage);
            charImg.src = images.bad; 
            charImg.classList.add("wrong-anim");
            clickedBtn.style.backgroundColor = "#999";
            clickedBtn.disabled = true;
        }
    }

    function finishGame() {
        stopBGM();
        
        const finalPercentage = Math.round((score / quizData.length) * 100);
        questionText.innerText = `ÂÖ®ÂïèÁµÇ‰∫ÜÔºÅÊúÄÁµÇ„Éù„Ç§„É≥„Éà: ${finalPercentage}%`;
        
        //
